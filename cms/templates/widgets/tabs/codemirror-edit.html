<%! from django.utils.translation import ugettext as _ %>
<%page args="tabName"/>
<div style="margin: -20px;">
  <textarea id="advanced-${html_id}" class="edit-box">${data | h}</textarea>
</div>

<script type='text/javascript'>
    $(document).ready(function(){
      (function(){
        ##Only one inner editor in tabs is supported in front-end. It means that
        ##you should have only one CodeMirror among tabs, one Tiny MCE, etc.

        ## Init CodeMirror editor
        var
          $el = $("#advanced-${html_id}"),
          advanced_editor = CodeMirror.fromTextArea(
            $el.get(0), {
              mode: "text/html",
              lineNumbers: true,
              lineWrapping: true
            }
          );
        ## Save link to CodeMirror in data attribute CodeMirror for further using in
        ## TabsEditorDescriptor for save data
        $el.data('CodeMirror', advanced_editor);


        ## Callback that ensures data sync between tabs
        TabsEditorDescriptor.registerTabCallback('${html_id}', '${tabName}', function(previous_tab){
          var $tinymce = $("#visual-${html_id}").data('TinyMCE');
          if ($tinymce && $tinymce.isDirty()){
            advanced_editor.setValue($tinymce.getContent({no_events: 1}))
            advanced_editor.setCursor(0)
          }

          ## CodeMirror should get focus when tab is active
          advanced_editor.refresh();
          advanced_editor.focus();
        })


        ## Save function - executes when pressing save - to get information from nested editor,

        ## should be set, as templates executes before tabs-aggregator coffee executes
        TabsEditorDescriptor['tabs_save_functions']['${html_id}'] = TabsEditorDescriptor['tabs_save_functions']['${html_id}']  || {}

        TabsEditorDescriptor['tabs_save_functions']['${html_id}']['${tabName}'] = function(){
          return function(){  return advanced_editor.getValue();}
        }();
      }());
    });
</script>
